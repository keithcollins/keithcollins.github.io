<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><!-- Primary Meta Tags --><title></title><meta name="title" content=""><meta name="description" content=" - Keith Collins"><link rel="canonical" href="https://keithcollins.github.io/blog/2026-02-08-good-forms/"><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://keithcollins.github.io/blog/2026-02-08-good-forms/"><meta property="og:title" content=""><meta property="og:description" content=" - Keith Collins"><meta property="og:image" content="https://keithcollins.github.io/images/og-image.jpg"><meta property="article:published_time" content="2026-02-08"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://keithcollins.github.io/blog/2026-02-08-good-forms/"><meta property="twitter:title" content=""><meta property="twitter:description" content=" - Keith Collins"><meta property="twitter:image" content="https://keithcollins.github.io/images/og-image.jpg"><!-- Favicon --><link rel="icon" href=""><!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@200;300;400;500;700&display=swap" rel="stylesheet"><style>.post[data-astro-cid-4sn4zg3r]{padding-bottom:20px;margin-bottom:20px;border-bottom:1px solid #ddd}.post[data-astro-cid-4sn4zg3r]>.date[data-astro-cid-4sn4zg3r]{font-size:12px;color:#999;margin-top:10px;margin-bottom:20px}.post[data-astro-cid-4sn4zg3r] h1[data-astro-cid-4sn4zg3r]{margin-bottom:0;line-height:1.2;font-weight:400}
header[data-astro-cid-3ef6ksr2]{margin-bottom:20px}h1[data-astro-cid-3ef6ksr2]{font-weight:700;margin:20px 0 10px}h1[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{color:#333;text-decoration:none}h1[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]:hover{text-decoration:underline}.breadcrumbs[data-astro-cid-3ef6ksr2]{font-size:14px;color:#666;margin-bottom:20px}.breadcrumbs[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{color:#06c;text-decoration:none}.breadcrumbs[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]:hover{text-decoration:underline}.separator[data-astro-cid-3ef6ksr2]{color:#999}*{box-sizing:border-box}body{margin:0;padding:10px;font-family:Roboto,sans-serif;font-size:16px;line-height:1.5;color:#333}main{position:relative;max-width:600px;margin:0 auto}main.game-size{max-width:400px}h1,h2,h3,h4,h5,h6{line-height:1.3}a{color:#06c}code{font-family:Source Code Pro,menlo,inconsolata,monospace;font-size:calc(1em - 2px);color:#555;background-color:#f0f0f0;padding:.2em .4em;border-radius:2px}pre{background-color:#f9f9f9;box-shadow:inset 1px 1px 5px #0000000d;padding:.5em;border-radius:2px;overflow-x:auto}pre code{background:none;padding:0}img{max-width:100%;height:auto}
</style></head> <body> <main class=""> <header data-astro-cid-3ef6ksr2><h1 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Good Forms by Keith Collins</a></h1></header><nav class="breadcrumbs" data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>home</a><span class="separator" data-astro-cid-3ef6ksr2> / </span><a href="/blog" data-astro-cid-3ef6ksr2>blog</a><span class="separator" data-astro-cid-3ef6ksr2> / </span><a href="/blog/2026-02-08-good-forms" data-astro-cid-3ef6ksr2>2026-02-08-good-forms</a></nav>  <div class="post" id="2026-02-08-good-forms" data-astro-cid-4sn4zg3r> <h1 data-astro-cid-4sn4zg3r></h1> <div class="date" data-astro-cid-4sn4zg3r>POSTED ON 2026-02-08</div> <div class="content" data-astro-cid-4sn4zg3r> <h2 id="-development-statistics">üìä Development Statistics</h2>
<p><strong>Total commits:</strong> 77</p>
<p><strong>Most changed files:</strong></p>
<ol>
<li><code>index.js</code> - 56 commits, 353 lines (final)</li>
<li><code>v8ui.js</code> ‚Üí <code>mainGraphics.js</code> + <code>smushGraphics.js</code> - 21 commits total</li>
</ol>
<p><strong>Lines of code (final count):</strong></p>
<ul>
<li><code>index.js</code>: 353 lines</li>
<li><code>state.js</code>: 216 lines</li>
<li><code>smush.js</code>: 292 lines</li>
<li><code>findAudioRegions.js</code>: 109 lines</li>
<li><code>audioBouncer.js</code>: 380 lines</li>
<li><code>bufferManager.js</code>: 120 lines</li>
<li><code>maxObjectManager.js</code>: 265 lines</li>
<li><code>mainGraphics.js</code>: 243 lines</li>
<li><code>smushGraphics.js</code>: ~90 lines</li>
<li><code>getBufferMinMax.js</code>: ~60 lines</li>
</ul>
<p><strong>Total:</strong> ~2,128 lines of JavaScript across 10 modules</p>
<h2 id="february-8-problems-with-audio-bouncing">February 8: Problems with audio bouncing</h2>
<h3 id="max-pains">Max pains</h3>
<p>I am having a lot of trouble getting the path to the temporary project folder Ableton Live creates for unsaved Live Sets.</p>
<p>At minimum, I would like to get the path to the user‚Äôs Temporary Folder, which is set in Ableton Live > Settings > File &#x26; Folder > Temporary Folder. By default on Mac it is:</p>
<p>~/Music/Ableton/Live Recordings/</p>
<p>What I really want is the full path to the current Live Set in the case that the Set has not yet been saved:</p>
<p>~/Music/Ableton/Live Recordings/2026-02-06 094518 Temp Project/</p>
<p>If you create a new Live Set in Ableton Live, add audio or MIDI to a track, then right-click on your clip and select ‚ÄúBounce Track in Place‚Äù or ‚ÄúBounce to New Track,‚Äù Ableton saves the bounced audio to:</p>
<p>~/Music/Ableton/Live Recordings/2026-02-06 094518 Temp Project/Samples/Processed/Bounce</p>
<p>I simply want to follow that pattern in the device I am working on. Since my device allows the user to bounce audio from the device‚Äôs buffer to a new audio track. It works fine if the Live Set has been saved, because I can get the path to the project folder and save the audio there. But if the Live Set has not yet been saved, I want to save the bounced audio the same way Ableton does by default.</p>
<p>I do not want to save to the Max temporary folder, which for me is:</p>
<p>~/Library/Application Support/Cycling ‚Äò74/Max 9/Settings/temp64-live</p>
<h3 id="clever-solution">Clever solution</h3>
<p>I finally found a solution. It‚Äôs very round-about, and if someone has a cleaner way to do this, please tell me. But here is what is currently working for me (using Live 12 and Max 9, V8 JavaScript):</p>
<p>Basically, I used Clip.crop() to trigger Live‚Äôs native file management, which reveals the temp folder path. When you call clip.crop() on an audio clip, Live creates a new consolidated audio file in its managed folder structure. By reading the clip‚Äôs file_path property before and after the crop operation, you can extract Live‚Äôs temporary project folder path.</p>
<ul>
<li>
<p>First, my device saves its output audio to Max‚Äôs temp folder.</p>
</li>
<li>
<p>I use the LiveAPI to create a track and load my audio file into a clip.</p>
</li>
<li>
<p>I use a Task with a delay to ensure the clip is fully created.</p>
</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> discoveryTask</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> clip</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> LiveAPI</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`live_set tracks ${</span><span style="color:#E1E4E8">trackIndex</span><span style="color:#9ECBFF">} arrangement_clips 0`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (clip.id </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not access clip</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Continue to next step...</span></span>
<span class="line"><span style="color:#E1E4E8">}, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">discoveryTask.</span><span style="color:#B392F0">schedule</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// 100ms delay</span></span>
<span class="line"></span></code></pre>
<ul>
<li>I trigger the crop operation and wait for Live to create the new file, then get the path to that file. Now the file lives in ~/Music/Ableton/Live Recordings/2026-02-06 185736 Temp Project/Samples/Processed/Crop which works for my purposes, and I now have the path to the temporary project folder, which I can use if the user bounces a new audio clip out of the device.</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D">// Call crop - this triggers Live's file management</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">clip.</span><span style="color:#B392F0">call</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"crop"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">// Wait for crop to complete</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> checkTask</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#79B8FF"> newPath</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> clip.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"file_path"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	post</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`New path: ${</span><span style="color:#E1E4E8">newPath</span><span style="color:#9ECBFF">[</span><span style="color:#79B8FF">0</span><span style="color:#9ECBFF">]</span><span style="color:#9ECBFF">}</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">	// Continue to extraction...</span></span>
<span class="line"><span style="color:#E1E4E8">}, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">checkTask.</span><span style="color:#B392F0">schedule</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// 100ms delay for crop operation</span></span>
<span class="line"></span></code></pre>
<h3 id="audio-bouncer-extracted-from-indexjs">Audio bouncer extracted from index.js</h3>
<p>Now that this works, I have extracted all bounce/export functionality into its own module.</p>
<p><strong>Created <code>audioBouncer.js</code> (380 lines)</strong> - A complete audio export system:</p>
<ul>
<li>Multi-format support (WAV, AIFF, FLAC)</li>
<li>Bit depth options (16/24/32-bit)</li>
<li>Sample rate conversion</li>
<li>Progress tracking</li>
<li>Error handling</li>
<li>File path management</li>
</ul>
<p><strong><code>index.js</code> shrunk dramatically:</strong> 181 lines removed, replaced with:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { AudioBouncer } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './audioBouncer.js'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> bouncer</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> AudioBouncer</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">bouncer.</span><span style="color:#B392F0">bounce</span><span style="color:#E1E4E8">(buffer, filepath, options);</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="-february-3-interactive-threshold-control">üéÆ February 3: Interactive threshold control</h2>
<h3 id="mouse-interactions">Mouse interactions</h3>
<p><strong>New capabilities:</strong></p>
<ul>
<li>Click-and-drag threshold adjustment</li>
<li>Visual feedback during interaction</li>
<li>Smooth value updates to UI controls</li>
</ul>
<p><code>mainGraphics.js</code> and <code>smushGraphics.js</code> got synced interaction patterns.</p>
<p><code>state.js</code> can track interaction state: <code>isHovering</code>, <code>isDragging</code>, <code>dragStartY</code>, etc.</p>
<h3 id="hover--cursor">Hover &#x26; cursor</h3>
<p>Refined the hover behavior.</p>
<p><strong>Polish details:</strong></p>
<ul>
<li>Worked on hover state rendering in <code>mainGraphics.js</code></li>
<li>TODO: Cursor changes to indicate draggability</li>
<li>Smooth transitions between states</li>
</ul>
<h3 id="line-dragging">Line dragging</h3>
<p>Fine-tuned the drag interaction to make it feel natural.</p>
<hr>
<h2 id="-january-28-29-crossfade-visualization">üé® January 28-29: Crossfade visualization</h2>
<h3 id="merge-points-jan-28-1019">Merge Points (Jan 28, 10:19)</h3>
<p>Started visualizing where audio regions get joined together.</p>
<p><strong>New feature in <code>smushGraphics.js</code>:</strong> Draw markers at crossfade points so you can see exactly where the audio is being spliced.</p>
<p><strong>Visual design:</strong></p>
<ul>
<li>Equal-power crossfades show as smooth S-curves</li>
<li>Linear crossfades show as straight diagonal lines</li>
<li>Markers at start/end of each crossfade region</li>
</ul>
<p>Now you can <em>see</em> how the audio is being blended. But‚Ä¶ it‚Äôs not as helpful as I expected. Especially for longer audio, it really just adds noise to the output waveform. Will likely drop it.</p>
<p>Documenting the math behind equal-power crossfading:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// Linear: 3dB dip in the middle</span></span>
<span class="line"><span style="color:#E1E4E8">outA </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> inA </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> -</span><span style="color:#E1E4E8"> position);</span></span>
<span class="line"><span style="color:#E1E4E8">outB </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> inB </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> position;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Equal-power: constant perceived loudness</span></span>
<span class="line"><span style="color:#E1E4E8">outA </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> inA </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">cos</span><span style="color:#E1E4E8">(position </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> Math.</span><span style="color:#79B8FF">PI</span><span style="color:#F97583"> /</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">outB </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> inB </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">sin</span><span style="color:#E1E4E8">(position </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> Math.</span><span style="color:#79B8FF">PI</span><span style="color:#F97583"> /</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<p><strong>Why equal-power?</strong> Human perception of loudness isn‚Äôt linear. Equal-power curves compensate for this, making crossfades sound smooth and natural.</p>
<h3 id="threshold-line-interaction">Threshold line interaction</h3>
<p>Made the threshold line interactive. You can now click and drag it up and down to adjust the silence threshold in real-time.</p>
<p><strong>Implementation details (<code>mainGraphics.js</code>):</strong></p>
<ul>
<li>Mouse events in v8ui: <code>onclick</code>, <code>ondrag</code>, <code>onidleout</code></li>
<li>Convert pixel Y position to dB value</li>
<li>Update state</li>
<li>Redraw graphics</li>
<li>Trigger reprocessing</li>
</ul>
<p><code>smushGraphics.js</code> also got interaction improvements.</p>
<hr>
<h2 id="-january-27-polishing">üíé January 27: Polishing</h2>
<h3 id="ui-updates-jan-25-1436">UI Updates (Jan 25, 14:36)</h3>
<ul>
<li>Added crossfade type selector with custom icons: for equal power, linear fade and no fade.</li>
<li>Updated color scheme based on Illustrator mockups</li>
</ul>
<p><code>state.js</code> grew to accommodate new UI parameters.</p>
<p><strong>Design detail:</strong> Exported <code>Granulator III.pdf</code> from Max for reference. Studying how Ableton‚Äôs flagship M4L devices handle UI helped inform our design decisions.</p>
<h3 id="state-simplification">State simplification</h3>
<p>Refactored <code>state.js</code> down from 222 lines to 97. Removed 125 lines of cruft that accumulated during development.</p>
<h3 id="bounce-feature">Bounce feature</h3>
<p>Added audio export functionality. You can now render the smushed audio to a new audio file.</p>
<p><code>index.js</code> is handling:</p>
<ul>
<li>File path selection</li>
<li>Buffer-to-disk writing</li>
<li>Progress feedback</li>
<li>Error handling</li>
</ul>
<h3 id="trimming-fat">Trimming fat</h3>
<p>Huge simplification of <code>state.js</code>, and <code>index.js</code> got a 165-line overhaul improving message handling and state synchronization.</p>
<h3 id="reset-issues">Reset issues</h3>
<p>It‚Äôs important that the user can drop a new audio clip into the device at any time, even if audio was previously loaded. So it‚Äôs also important that when that happens, the device resets.</p>
<p><strong>The problem:</strong> State wasn‚Äôt fully clearing when it got new audio. Some UI elements remembered old values, waveforms showed ghost data, etc.</p>
<h3 id="buffer-stuff">Buffer stuff</h3>
<p>Proper sequencing of buffer operations:</p>
<ol>
<li>Stop transport (prevents clicks)</li>
<li>Clear old buffer</li>
<li>Initialize new buffer</li>
<li>Update UI</li>
<li>Notify graphics layers</li>
<li>Resume transport if needed</li>
</ol>
<h3 id="floor-ui">Floor UI</h3>
<p>Added an experimental ‚Äúfloor‚Äù parameter that allows the user to adjust the visible floor of the input audio, essentially zooming in vertically. It works, but it doesn‚Äôt feel super helpful.</p>
<hr>
<h2 id="-january-24-good-progress">‚úÖ January 24: Good progress</h2>
<h3 id="working-on-device-reset">Working on device reset</h3>
<p>Complete rewrite of the reset functionality using the new state system.</p>
<p>Deleted <code>v8ui.js</code>, fully switched to <code>mainGraphics.js</code> and <code>smushGraphics.js</code>, each of which handles painting for their respective v8ui objects.</p>
<p>Split graphics rendering into two specialized files:</p>
<ul>
<li><code>mainGraphics.js</code> handles the main buffer visualization</li>
<li><code>smushGraphics.js</code> handles the smushed buffer + crossfade overlays</li>
</ul>
<h3 id="initialization-refinement">Initialization refinement</h3>
<p>Fixed a subtle race condition: the <code>bufferInit</code> flag was being set too early in the initialization sequence, causing occasional glitches when loading audio quickly.</p>
<p><strong>The fix:</strong> Move the flag to the very end of <code>initBuffer()</code>, after ALL initialization is complete.</p>
<h3 id="looking-good">Looking good</h3>
<p>Everything is working pretty well. Reset button: ‚úÖ. Buffer loading: ‚úÖ. Silence detection: ‚úÖ. Crossfades: ‚úÖ. UI updates: ‚úÖ.</p>
<h3 id="design-work">Design work</h3>
<p>More UI sketching:</p>
<hr>
<h2 id="-january-23-no-more-datamanager">üîß January 23: (No more DataManager)</h2>
<h3 id="datamanager--statejs">DataManager ‚Üí State.js</h3>
<p>Big decision: DataManager isn‚Äôt working out. The Dictionary-based persistence is causing race conditions and state desync issues.</p>
<p>Max‚Äôs Dictionary objects are great for patchers, but in JS they add unnecessary complexity. Switched to a plain object and Global for cross-script communication.</p>
<h3 id="new-stuff">New stuff</h3>
<p><strong>Created three new files:</strong></p>
<ul>
<li><strong><code>state.js</code></strong> (201 lines) - Global-based state management</li>
<li><strong><code>mainGraphics.js</code></strong> (138 lines) - Main waveform rendering logic</li>
<li><strong><code>smushGraphics.js</code></strong> (61 lines) - Smushed waveform rendering logic</li>
</ul>
<p><strong>New architecture:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// state.js creates a device-specific Global</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> stateGlobal</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Global</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`smush_state_${</span><span style="color:#E1E4E8">deviceId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Any script can now access/modify state</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { state } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> './state.js'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">state.thresholdDb </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">40</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span></code></pre>
<p><strong>Why Global?</strong> Unlike Dictionaries, Globals are just JavaScript objects living in Max‚Äôs JS engine. Fast, simple, and they work exactly how you‚Äôd expect objects to work.</p>
<hr>
<h2 id="-january-22-snapshot-playhead--the-rmspeak-journey">üéØ January 22: Snapshot, Playhead &#x26; The RMS‚ÜíPeak Journey</h2>
<h3 id="snapshot-feature">Snapshot Feature</h3>
<p>Added the ability to capture the current device state for recall.</p>
<p><strong>Refactor:</strong> Simplified <code>findAudioRegions.js</code> by removing redundant code.</p>
<h3 id="playhead-visualization">Playhead Visualization</h3>
<p>Rebuilt the playback playhead from scratch. Now you can see exactly where you are in the waveform during playback.</p>
<p><strong>Technical approach:</strong></p>
<ul>
<li>Listen to Max‚Äôs transport position</li>
<li>Convert to buffer samples</li>
<li>Draw a vertical line in v8ui</li>
<li>Update at ~30fps for smooth animation</li>
</ul>
<h3 id="v8ui-for-creation-waveform">V8UI for Creation Waveform</h3>
<p>Added a second v8ui overlay specifically for the smushed buffer visualization. Now both <code>---main</code> and <code>---smush</code> have their own UI layers.</p>
<h3 id="db-linear-slider">dB-Linear Slider</h3>
<p>Threshold control got a major upgrade. Worked on some UI mockups.</p>
<h3 id="plot-integration-attempt">Plot~ Integration Attempt</h3>
<p>Trying to figure out if <code>plot~</code> would be better than <code>waveform~</code> for visualization.</p>
<h3 id="horizontal-line-working-now-switching-from-rms-to-peak">horizontal line working, now switching from RMS to peak</h3>
<p>Added the threshold visualization: a draggable horizontal line showing the current silence threshold in dB.</p>
<p><strong>The problem:</strong> The device was using RMS (root-mean-square) for silence detection, but Max‚Äôs <code>waveform~</code> and <code>plot~</code> objects display peak values. This meant the threshold line didn‚Äôt align with the visual waveform. Confusing!</p>
<h3 id="implemented-peak-lookin-for-leak">implemented peak, lookin for leak</h3>
<p>Switched to peak-based detection. Now the silence threshold visually aligns with what you see in the waveform.</p>
<p><strong>But‚Ä¶</strong> memory leak detected. After processing several buffers, Max‚Äôs memory usage kept climbing. üêõ</p>
<p><strong>The culprit:</strong> Creating new <code>Buffer</code> objects without freeing old ones. Each buffer is a peer object that Max has to manage. If you don‚Äôt call <code>freepeer()</code>, they accumulate in memory.</p>
<hr>
<h2 id="-january-21-ui-polish--peak-detection">üé® January 21: UI Polish &#x26; Peak Detection</h2>
<h3 id="design-exploration">Design Exploration</h3>
<p>Moved all SVG assets into <code>/images/</code> folder for organization. Created <code>toggle.amxd</code> as a side experiment for testing UI patterns.</p>
<p><strong><code>v8ui.js</code> evolved:</strong> 50 lines of improvements to rendering logic. Started thinking about how the threshold line should be drawn.</p>
<h3 id="dropping-async">Dropping Async</h3>
<p>Something broke in the async experiment. Reverted changes to <code>findAudioRegions.js</code> and <code>getBufferMinMax.js</code>.</p>
<p><strong>Lesson learned:</strong> Async in Max is tricky. The scheduler model is different from Node.js. Reverted to sync processing for stability.</p>
<h3 id="midi-integration">MIDI Integration</h3>
<p>Now you can trigger the smushed audio with MIDI notes.</p>
<h3 id="state-management-overhaul">State Management Overhaul</h3>
<p>Three late-night commits fixing persistent state issues. The waveforms weren‚Äôt resetting properly when loading new files.</p>
<p><strong>The bug:</strong> <code>v8ui</code> was holding onto stale buffer references.</p>
<p><strong>The fix:</strong> Added explicit refresh messages to <code>v8ui.js</code> whenever buffers change. Also improved the lifecycle: init ‚Üí load ‚Üí paint ‚Üí clear ‚Üí repeat.</p>
<h3 id="minmax-optimization">Min/Max Optimization</h3>
<p>Improved <code>getBufferMinMax.js</code> with smarter caching. If you‚Äôre drawing the same region twice, don‚Äôt recalculate.</p>
<hr>
<h2 id="Ô∏è-january-17">üèóÔ∏è January 17</h2>
<h3 id="performance-refactor">Performance Refactor</h3>
<p>Tried an async version of the smush script. TypedArrays and frame-based processing to handle large files without blocking the Max scheduler.</p>
<p><strong>Key insight:</strong> Max‚Äôs <code>poke~</code> is synchronous and can choke on big buffers. Solution: process in chunks, use <code>Task</code> for yielding back to the scheduler. But it makes the UI slow and clunky, so may ditch.</p>
<h3 id="buffermanager-class">BufferManager Class</h3>
<p>Created <code>bufferManager.js</code> (174 lines) to handle buffer lifecycle management:</p>
<ul>
<li>Automatic <code>freepeer()</code> cleanup to prevent memory leaks</li>
<li>Centralized buffer creation and reference caching</li>
<li>Two-buffer coordination (main ‚Üî smush)</li>
</ul>
<p>One class owns all buffer operations. <code>index.js</code> just says ‚Äúgive me the main buffer‚Äù and doesn‚Äôt worry about the messy details.</p>
<h3 id="performance-tools">Performance Tools</h3>
<p>Built <code>getBufferMinMax.js</code>, a utility to quickly find min/max values in a buffer region for visualization scaling. Uses TypedArray <code>peek()</code> for fast traversal.</p>
<p><strong>Optimization:</strong> Instead of checking every single sample for waveform display, we sample strategically based on pixel width. If the waveform is 500 pixels wide, we don‚Äôt need to check all 2 million samples.</p>
<h3 id="datamanager-introduction">DataManager Introduction</h3>
<p>New <code>dataManager.js</code> to centralize state. All the device parameters‚Äîthreshold, crossfade times, min region size‚Äînow live in one managed object.</p>
<p><strong>Design pattern:</strong> Dictionary-based data persistence.</p>
<h3 id="maxobjectmanager">MaxObjectManager</h3>
<p>The modular architecture saga continues with <code>maxObjectManager.js</code> (250 lines)‚Äîa caching layer for Max objects.</p>
<p><strong>Problem solved:</strong> Constantly calling <code>this.patcher.getnamed("some_object")</code> is expensive. This manager gets each object reference ONCE and caches it.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6A737D">// Old way (called every paint frame):</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> waveform</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.patcher.</span><span style="color:#B392F0">getnamed</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"waveform_display"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// New way (cached):</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> waveform</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> maxObjects.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"waveform_display"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<p>UI redesign too, with somewhat better visual hierarchy.</p>
<hr>
<h2 id="-january-15-16">üöÄ January 15-16</h2>
<h3 id="the-big-bang">The Big Bang</h3>
<p>First real commit with original core files:</p>
<ul>
<li><strong><code>index.js</code></strong> (242 lines) - Main entry point and orchestrator</li>
<li><strong><code>smush.js</code></strong> (209 lines) - Core audio processing logic</li>
<li><strong><code>findAudioRegions.js</code></strong> (71 lines) - Silence detection algorithm</li>
<li><strong><code>v8ui.js</code></strong> (119 lines) - Custom UI rendering with Max‚Äôs v8ui</li>
<li><strong><code>Smush.amxd</code></strong> - The Max for Live device file itself</li>
<li><strong><code>README.md</code></strong> - Initial documentation</li>
</ul>
<p><strong>Technical decisions made:</strong></p>
<ul>
<li>V8 JavaScript engine for modern ES6+ support</li>
<li>Module system with CommonJS imports/exports for clean separation of concerns</li>
<li>Custom <code>v8ui</code> overlays on native Max waveform objects</li>
</ul>
<h3 id="two-buffer-architecture">Two-Buffer Architecture</h3>
<p>Early realization: we need two buffers, not one:</p>
<ul>
<li><code>---main</code>: The original, untouched audio (sacred!)</li>
<li><code>---smush</code>: Where we do our destructive edits</li>
</ul>
<p>This way, you can always reset back to the original.</p>
<h3 id="stabilization">Stabilization</h3>
<ul>
<li>Improved initialization reliability</li>
<li>Core audio processing refined</li>
<li>Audio playback working</li>
<li>The device is somewhat working. You can drop in audio, smush it, and hear the result.</li>
</ul>
<p>By evening: <strong>finally fixed buffer clear</strong> - The reset button actually works now. This involved understanding Max‚Äôs buffer lifecycle and when to call <code>clear()</code> vs reassigning samples.</p>
<h3 id="ui--control-layer">UI &#x26; Control Layer</h3>
<ul>
<li>Added transport controls</li>
<li>Created proper button layouts for load, reset, smush, and bounce</li>
</ul>
<hr> </div> </div>  </main> </body></html> 